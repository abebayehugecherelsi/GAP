create or replace PROCEDURE "BUILD_SPEND_CUBE" AS
BEGIN
  --  below index seciones were commneted out on 12/27/2022 because they do not exist in GAPCAS
---CREATE INDEXES
    ---- EXECUTE IMMEDIATE 'ALTER INDEX SRC_ERP_SRC_TEAM_SRC_CAT_AREA_I REBUILD';
    -- COMMIT;
    -- EXECUTE IMMEDIATE 'ALTER INDEX SRC_ERP_SRC_TEAM_SRC_CAT_AREA_I COMPUTE STATISTICS';
    -- COMMIT;
    -- EXECUTE IMMEDIATE 'ALTER INDEX LGL_ENTTY_CNTRY_I REBUILD';
    -- COMMIT;
    -- EXECUTE IMMEDIATE 'ALTER INDEX LGL_ENTTY_CNTRY_I COMPUTE STATISTICS';
    -- COMMIT;

---DROP TABLES
    EXECUTE IMMEDIATE 'DROP TABLE GAP_SPEND_CUBE';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_APAC_CUBE';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_SPEND_EXEC_SUMMARY';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_SPEND_SUP_CHN_SUMMARY';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_SPEND_TECH_SUMMARY';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_CONT_OUTSRC';
    COMMIT;
    EXECUTE IMMEDIATE 'DROP TABLE GAP_MRKT_GWTH_CORP_SERV';
    COMMIT;

---CREATE TABLES
    EXECUTE IMMEDIATE 'CREATE TABLE GAP_SPEND_CUBE AS
SELECT ACCOUNT,
       ACCOUNT_CODE,
       AREA_CODE,
       AREA_DESCRIPTION,
       BUYER,
       BUYER_PO,
       DEPARTMENT,
       DEPARTMENT_CODE,
       DIVISION,
       DIVISION_CODE,
       EXPENSE_CATEGORY,
       EXPENSE_TYPE,
       FISCAL_MONTH,
       FISCAL_QUARTER,
       FISCAL_YEAR,
       FLAG_MULTIPLE_PARENT_LINKAGE,
       FLAG_PO_COMPLIANCE,
       FLAG_SUPPLIER_PAYMENT_TERM,
       GL_CURRENCY,
       GL_EXCHANGE_RATE_TYPE,
       INTER_UNIT,
       INTER_UNIT_DESCRIPTION,
       INVOICE_PAYMENT_TERMS_CODE,
       INVOICE_PAYMENT_TERMS,
       INVOICE_TYPE,
       LEGAL_ENTITY_CODE,
       LEGAL_ENTITY,
       LEGAL_ENTITY_COUNTRY,
       LEGAL_ENTITY_REGION,
       LEVEL_1_CATEGORY,
       LEVEL_2_CATEGORY,
       LEVEL_3_CATEGORY,
       LEVEL_4_CATEGORY,
       MATERIAL_GROUP_CODE,
       MATERIAL_GROUP,
       MERCH_DEPT,
       MERCH_DEPT_DESCRIPTION,
       PERIOD_NAME,
       PURCHASE_ORGANIZATION_CODE,
       PURCHASE_ORGANIZATION,
       REQUISITIONER_ID,
       REQUISITIONER,
       REQUISITIONER_COUNTRY,
       SIC_CODE,
       SOURCE_INVOICE,
       SOURCE_ERP,
       SOURCING_CATEGORY_AREA,
       SOURCING_LEAD,
       SOURCING_TEAM,
       SOURCING_TEAM2,
       SPEND_BUCKET,
       SUPPLIER_ERP, 
       SUPPLIER_NORMALIZED,
       SUPPLIER_PARENT,
       SUPPLIER_NUMBER,
       SUPPLIER_PAYMENT_TERM_CODE,
       SUPPLIER_PAYMENT_TERM_DESC,
       SUPPLIER_STATE,
       SUPPLIER_COUNTRY,
       SUPPLIER_TYPE,
       VENDOR_SITE_CODE,
       SOURCING_SEGMENT,
       SPEND_TIERS_ANNUAL,
       SUM( SPEND_USD ) SPEND_USD
FROM GAP_SPEND_FINAL
GROUP BY ACCOUNT,
       ACCOUNT_CODE,
       AREA_CODE,
       AREA_DESCRIPTION,
       BUYER,
       BUYER_PO,
       DEPARTMENT,
       DEPARTMENT_CODE,
       DIVISION,
       DIVISION_CODE,
       EXPENSE_CATEGORY,
       EXPENSE_TYPE,
       FISCAL_MONTH,
       FISCAL_QUARTER,
       FISCAL_YEAR,
       FLAG_MULTIPLE_PARENT_LINKAGE,
       FLAG_PO_COMPLIANCE,
       FLAG_SUPPLIER_PAYMENT_TERM,
       GL_CURRENCY,
       GL_EXCHANGE_RATE_TYPE,
       INTER_UNIT,
       INTER_UNIT_DESCRIPTION,
       INVOICE_PAYMENT_TERMS_CODE,
       INVOICE_PAYMENT_TERMS,
       INVOICE_TYPE,
       LEGAL_ENTITY_CODE,
       LEGAL_ENTITY,
       LEGAL_ENTITY_COUNTRY,
       LEGAL_ENTITY_REGION,
       LEVEL_1_CATEGORY,
       LEVEL_2_CATEGORY,
       LEVEL_3_CATEGORY,
       LEVEL_4_CATEGORY,
       MATERIAL_GROUP_CODE,
       MATERIAL_GROUP,
       MERCH_DEPT,
       MERCH_DEPT_DESCRIPTION,
       PERIOD_NAME,
       PURCHASE_ORGANIZATION_CODE,
       PURCHASE_ORGANIZATION,
       REQUISITIONER_ID,
       REQUISITIONER,
       REQUISITIONER_COUNTRY,
       SIC_CODE,
       SOURCE_INVOICE,
       SOURCE_ERP,
       SOURCING_CATEGORY_AREA,
       SOURCING_LEAD,
       SOURCING_TEAM,
       SOURCING_TEAM2,
       SPEND_BUCKET,
       SUPPLIER_ERP,
       SUPPLIER_NORMALIZED,
       SUPPLIER_PARENT,
       SUPPLIER_NUMBER,
       SUPPLIER_PAYMENT_TERM_CODE,
       SUPPLIER_PAYMENT_TERM_DESC,
       SUPPLIER_STATE,
       SUPPLIER_COUNTRY,
       SUPPLIER_TYPE,
       VENDOR_SITE_CODE,
       SOURCING_SEGMENT,
       SPEND_TIERS_ANNUAL';

EXECUTE IMMEDIATE 'CREATE TABLE GAP_APAC_CUBE AS
SELECT ACCOUNT,
       ACCOUNT_CODE,
       AREA_CODE,
       AREA_DESCRIPTION,
       BUYER,
       BUYER_PO,
       DEPARTMENT,
       DEPARTMENT_CODE,
       DIVISION,
       DIVISION_CODE,
       EXPENSE_CATEGORY,
       EXPENSE_TYPE,
       FISCAL_MONTH,
       FISCAL_QUARTER,
       FISCAL_YEAR,
       FLAG_MULTIPLE_PARENT_LINKAGE,
       FLAG_PO_COMPLIANCE,
       FLAG_SUPPLIER_PAYMENT_TERM,
       GL_CURRENCY,
       GL_EXCHANGE_RATE_TYPE,
       INTER_UNIT,
       INTER_UNIT_DESCRIPTION,
       INVOICE_PAYMENT_TERMS_CODE,
       INVOICE_PAYMENT_TERMS,
       INVOICE_TYPE,
       LEGAL_ENTITY_CODE,
       LEGAL_ENTITY,
       LEGAL_ENTITY_COUNTRY,
       LEGAL_ENTITY_REGION,
       LEVEL_1_CATEGORY,
       LEVEL_2_CATEGORY,
       LEVEL_3_CATEGORY,
       LEVEL_4_CATEGORY,
       MATERIAL_GROUP_CODE,
       MATERIAL_GROUP,
       MERCH_DEPT,
       MERCH_DEPT_DESCRIPTION,
       PERIOD_NAME,
       PURCHASE_ORGANIZATION_CODE,
       PURCHASE_ORGANIZATION,
       REQUISITIONER_ID,
       REQUISITIONER,
       REQUISITIONER_COUNTRY,
       SIC_CODE,
       SOURCE_INVOICE,
       SOURCE_ERP,
       SOURCING_CATEGORY_AREA,
       SOURCING_LEAD,
       SOURCING_TEAM,
       SPEND_BUCKET,
       SUPPLIER_ERP,
       SUPPLIER_NORMALIZED,
       SUPPLIER_PARENT,
       SUPPLIER_NUMBER,
       SUPPLIER_PAYMENT_TERM_CODE,
       SUPPLIER_PAYMENT_TERM_DESC,
       SUPPLIER_STATE,
       SUPPLIER_COUNTRY,
       SUPPLIER_TYPE,
       VENDOR_SITE_CODE,
       SOURCING_SEGMENT,
       SPEND_TIERS_ANNUAL,
       SUM( SPEND_USD ) SPEND_USD
FROM GAP_SPEND_FINAL
WHERE LEGAL_ENTITY_COUNTRY IN (''CHINA'' , ''HONG KONG'', ''TAIWAN'', ''JAPAN'')
GROUP BY ACCOUNT,
       ACCOUNT_CODE,
       AREA_CODE,
       AREA_DESCRIPTION,
       BUYER,
       BUYER_PO,
       DEPARTMENT,
       DEPARTMENT_CODE,
       DIVISION,
       DIVISION_CODE,
       EXPENSE_CATEGORY,
       EXPENSE_TYPE,
       FISCAL_MONTH,
       FISCAL_QUARTER,
       FISCAL_YEAR,
       FLAG_MULTIPLE_PARENT_LINKAGE,
       FLAG_PO_COMPLIANCE,
       FLAG_SUPPLIER_PAYMENT_TERM,
       GL_CURRENCY,
       GL_EXCHANGE_RATE_TYPE,
       INTER_UNIT,
       INTER_UNIT_DESCRIPTION,
       INVOICE_PAYMENT_TERMS_CODE,
       INVOICE_PAYMENT_TERMS,
       INVOICE_TYPE,
       LEGAL_ENTITY_CODE,
       LEGAL_ENTITY,
       LEGAL_ENTITY_COUNTRY,
       LEGAL_ENTITY_REGION,
       LEVEL_1_CATEGORY,
       LEVEL_2_CATEGORY,
       LEVEL_3_CATEGORY,
       LEVEL_4_CATEGORY,
       MATERIAL_GROUP_CODE,
       MATERIAL_GROUP,
       MERCH_DEPT,
       MERCH_DEPT_DESCRIPTION,
       PERIOD_NAME,
       PURCHASE_ORGANIZATION_CODE,
       PURCHASE_ORGANIZATION,
       REQUISITIONER_ID,
       REQUISITIONER,
       REQUISITIONER_COUNTRY,
       SIC_CODE,
       SOURCE_INVOICE,
       SOURCE_ERP,
       SOURCING_CATEGORY_AREA,
       SOURCING_LEAD,
       SOURCING_TEAM,
       SPEND_BUCKET,
       SUPPLIER_ERP,
       SUPPLIER_NORMALIZED,
       SUPPLIER_PARENT,
       SUPPLIER_NUMBER,
       SUPPLIER_PAYMENT_TERM_CODE,
       SUPPLIER_PAYMENT_TERM_DESC,
       SUPPLIER_STATE,
       SUPPLIER_COUNTRY,
       SUPPLIER_TYPE,
       VENDOR_SITE_CODE,
       SOURCING_SEGMENT,
       SPEND_TIERS_ANNUAL';

EXECUTE IMMEDIATE 'CREATE TABLE GAP_SPEND_EXEC_SUMMARY AS
SELECT FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,SUM(SPEND_USD) SPEND_USD
,SUM(TRANSACTIONS) TRANSACTIONS
FROM GAP_SPEND_FINAL
GROUP BY FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP';
COMMIT;

EXECUTE IMMEDIATE 'CREATE TABLE GAP_SPEND_SUP_CHN_SUMMARY AS
SELECT FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE
,SUM(SPEND_USD) SPEND_USD
,SUM(TRANSACTIONS) TRANSACTIONS
FROM GAP_SPEND_FINAL
WHERE SOURCING_TEAM = ''SUPPLY CHAIN''
GROUP BY FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE';
COMMIT;

EXECUTE IMMEDIATE 'CREATE TABLE GAP_SPEND_TECH_SUMMARY AS
SELECT FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE
,SUM(SPEND_USD) SPEND_USD
,SUM(TRANSACTIONS) TRANSACTIONS
FROM GAP_SPEND_FINAL
WHERE SOURCING_TEAM = ''TECHNOLOGY''
GROUP BY FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE';
COMMIT;

EXECUTE IMMEDIATE 'CREATE TABLE GAP_MRKT_GWTH_CORP_SERV AS
SELECT FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE
,SUM(SPEND_USD) SPEND_USD
,SUM(TRANSACTIONS) TRANSACTIONS
FROM GAP_SPEND_FINAL
WHERE SOURCING_TEAM = ''MARKETING, RETAIL CUSTOMER EXPERIENCE & CORPORATE SERVICES''
GROUP BY FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,DIVISION
,FLAG_PO_COMPLIANCE';
COMMIT;

EXECUTE IMMEDIATE 'CREATE TABLE GAP_CONT_OUTSRC AS
SELECT FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP
,SUM(SPEND_USD) SPEND_USD
,SUM(TRANSACTIONS) TRANSACTIONS
FROM GAP_SPEND_FINAL
WHERE SOURCING_TEAM = ''CONTINGENT & OUTSOURCING''
GROUP BY FISCAL_YEAR
,FISCAL_QUARTER
,FISCAL_MONTH
,LEGAL_ENTITY_REGION
,LEGAL_ENTITY_COUNTRY
,LEGAL_ENTITY_CODE
,LEGAL_ENTITY
,SOURCING_TEAM
,SOURCING_TEAM2
,SOURCING_CATEGORY_AREA
,LEVEL_1_CATEGORY
,LEVEL_2_CATEGORY
,LEVEL_3_CATEGORY
,LEVEL_4_CATEGORY
,SUPPLIER_NORMALIZED
,SOURCE_ERP';
COMMIT;

END BUILD_SPEND_CUBE;
